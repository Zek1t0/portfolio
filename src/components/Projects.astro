---
import Card from "./Card.astro";

const { lang = "en" } = Astro.props;

const copy = {
  en: {
    heading: "My projects",
    projects: [
      
      {
        title: "Project 01 — Comedor Luna",
        subtitle: "Real website for a community food project",
        description1:
        "Comedor Luna is a real website currently in use by a local community food project. The goal was to build a simple site that presents information in a simple and organized way.",
        description2:
        "I built the site with a responsive layout, section-based navigation, and a strong focus on readability and mobile usability. This was a real-world website with real users and practical requirements.",
        meta: [
          { label: "Technology used", value: "Astro · TailwindCSS" },
          { label: "Language used", value: "HTML · CSS · JavaScript" },
          { label: "Framework used", value: "Astro" },
          { label: "Tool used", value: "" },
        ],
        imageSrc: "/comedor-luna.jpg",
        videoSrc: "/preview-blog2.mp4",
        liveUrl: "https://zek1t0.github.io/comedor-luna/",
        repoUrl: "https://github.com/Zek1t0/comedor-luna",
      },
      
      {
        title: "Project 02 — Personal Portfolio",
        subtitle: "Showcasing my work and skills",
        description1:
          "This is my personal portfolio website, which I actively use to showcase my projects and experience. It is designed to be clean and easy to navigate, with a strong focus on clarity and structure.",
        description2:
          "The site includes sections for my profile, skills, featured projects, and contact details. I implemented JavaScript scripts to improve interaction and created a consistent UI throughout: clear layouts, consistent styling, and practical solutions.",
        meta: [
          { label: "Technology used", value: "Astro" },
          { label: "Language used", value: "HTML · CSS · JavaScript" },
          { label: "Framework used", value: "Astro" },
          { label: "Tool used", value: "" },
        ],
        imageSrc: "/personal-portfolio.png",
        videoSrc: "/preview-blog.mp4",
        liveUrl: "http://duarteezequiel-portfolio.vercel.app/",
        repoUrl: "https://github.com/Zek1t0/portfolio",
      },

      {
        title: "Project 03 — Travel Blog",
        subtitle: "Full-stack blog application (team project)",
        description1:
          "This project is a full-stack travel blog developed as part of a group project. It includes user roles (admin, editor, and reader), allowing different levels of interaction with the platform.",
        description2:
          "The application supports full CRUD functionality for posts and typical blog features. The project helped me gain experience working with back-end logic, databases, and team-based development.",
        meta: [
          { label: "Technology used", value: "Python · Django" },
          { label: "Language used", value: "HTML · CSS" },
          { label: "Framework used", value: "Django" },
          { label: "Tool used", value: "Teamwork" },
        ],
        imageSrc: "/travel-blog.jpg",
        videoSrc: "/travel-blog-preview.mp4",
        liveUrl: "https://sudonostalgia.pythonanywhere.com/",
        repoUrl: "https://github.com/Ahresenal/Info-2025-grupo-2",
      },
    ],
  },

  es: {
    heading: "Mis proyectos",
    projects: [
      {
        title: "Proyecto 01 — Comedor Luna",
        subtitle: "Sitio real para un comedor comunitario",
        description1:
          "Comedor Luna es un sitio real que está en uso por un negocio local. El objetivo fue armar un sitio simple que presente la información de forma ordenada y fácil de entender.",
        description2:
          "Hice el sitio con diseño responsivo, navegación por secciones y foco en legibilidad y usabilidad en mobile. Es un proyecto del mundo real, con usuarios reales y requisitos concretos.",
        meta: [
          { label: "Tecnología usada", value: "Astro · TailwindCSS" },
          { label: "Lenguajes usados", value: "HTML · CSS · JavaScript" },
          { label: "Framework usado", value: "Astro" },
          { label: "Herramienta usada", value: "" },
        ],
        imageSrc: "/comedor-luna.jpg",
        videoSrc: "/preview-blog2.mp4",
        liveUrl: "https://zek1t0.github.io/comedor-luna/",
        repoUrl: "https://github.com/Zek1t0/comedor-luna",
      },

      {
        title: "Proyecto 02 — Portfolio personal",
        subtitle: "Mostrando mi trabajo y mis habilidades",
        description1:
          "Este es mi sitio de portfolio personal, que uso activamente para mostrar mis proyectos y experiencia. La idea es que sea limpio y fácil de navegar, con un enfoque fuerte en claridad y estructura.",
        description2:
          "El sitio incluye secciones de perfil, habilidades, proyectos destacados y contacto. Implementé scripts en JavaScript para mejorar la interacción y cuidé la UI en general: layouts claros, estilo consistente y soluciones prácticas.",
        meta: [
          { label: "Tecnología usada", value: "Astro" },
          { label: "Lenguajes usados", value: "HTML · CSS · JavaScript" },
          { label: "Framework usado", value: "Astro" },
          { label: "Herramienta usada", value: "" },
        ],
        imageSrc: "/personal-portfolio.png",
        videoSrc: "/preview-blog.mp4",
        liveUrl: "http://duarteezequiel-portfolio.vercel.app/",
        repoUrl: "https://github.com/Zek1t0/portfolio",
      },


      {
        title: "Proyecto 03 — Blog de viajes",
        subtitle: "Aplicación full-stack (proyecto en equipo)",
        description1:
          "Este proyecto es un blog de viajes full-stack desarrollado como parte de un trabajo grupal. Incluye roles de usuario (admin, editor y lector), permitiendo distintos niveles de interacción con la plataforma.",
        description2:
          "La app soporta CRUD completo para posts y funcionalidades típicas de un blog. El proyecto me ayudó a ganar experiencia conectando front con lógica de back-end, base de datos y laburo en equipo.",
        meta: [
          { label: "Tecnología usada", value: "Django" },
          { label: "Lenguajes usados", value: "Python · HTML · CSS" },
          { label: "Framework usado", value: "Django" },
          { label: "Herramienta usada", value: "Teamwork" },
        ],
        imageSrc: "/travel-blog.jpg",
        videoSrc: "/travel-blog-preview.mp4",
        liveUrl: "https://sudonostalgia.pythonanywhere.com/",
        repoUrl: "https://github.com/Ahresenal/Info-2025-grupo-2",
      },
    ],
  },
};

const t = lang === "es" ? copy.es : copy.en;
const projects = t.projects;
---

<section id="projects" class="w-full max-w-7xl mx-auto px-4 mb-40">
  <h2 class="font-roboto text-4xl font-bold mb-14 text-center text-cerise-600 dark:text-emerald-400">
    {t.heading}
  </h2>

  <div class="space-y-24">
    {projects.map((p) => <Card {...p} />)}
  </div>
</section>


<script is:inline>
  (() => {
    const reduceMotion =
      window.matchMedia?.("(prefers-reduced-motion: reduce)")?.matches ?? false;

    const cards = Array.from(document.querySelectorAll("[data-project-card]"));
    if (!cards.length) return;

    const ratios = new Map(cards.map((el) => [el, 0]));
    let activeEl = null;
    let rafId = 0;

    const ACTIVATE_AT = 0.5;
    const STAY_AT = 0.28;
    const UNLOAD_AT = 0.01;
    const SWITCH_MARGIN = 0.08;

    const getVideo = (card) => card.querySelector("video[data-video-src]");

    function ensureVideoLoaded(v) {
      if (!v) return;
      if (v.dataset.loaded === "true") return;
      const src = v.dataset.videoSrc; // data-video-src => dataset.videoSrc
      if (!src) return;

      v.src = src;
      v.dataset.loaded = "true";
      v.load();
    }

    function unloadVideo(v) {
      if (!v) return;
      if (v.dataset.loaded !== "true") return;

      try { v.pause(); } catch (_) {}
      v.removeAttribute("src");
      v.load();
      v.dataset.loaded = "false";
    }

    function pickBestActive() {
      if (activeEl) {
        const ar = ratios.get(activeEl) ?? 0;
        if (ar >= STAY_AT) {
          let bestEl = activeEl;
          let bestRatio = ar;
          for (const [el, r] of ratios.entries()) {
            if (r > bestRatio + SWITCH_MARGIN) {
              bestRatio = r;
              bestEl = el;
            }
          }
          return bestEl;
        }
      }

      let bestEl = null;
      let bestRatio = 0;
      for (const [el, r] of ratios.entries()) {
        if (r > bestRatio) {
          bestRatio = r;
          bestEl = el;
        }
      }
      return bestEl && bestRatio >= ACTIVATE_AT ? bestEl : null;
    }

    function applyActive(nextActive) {
      // set data-inview para que el CSS de Card haga lo suyo
      for (const c of cards) c.dataset.inview = c === nextActive ? "true" : "false";

      // pausar el anterior
      if (activeEl && activeEl !== nextActive) {
        const prevV = getVideo(activeEl);
        try { prevV?.pause(); } catch (_) {}
      }

      activeEl = nextActive;

      // activar el nuevo
      if (activeEl) {
        const v = getVideo(activeEl);
        ensureVideoLoaded(v);
        if (v && !reduceMotion) v.play().catch(() => {});
      }

      // descargar los lejanos
      for (const c of cards) {
        if (c === activeEl) continue;
        const r = ratios.get(c) ?? 0;
        if (r <= UNLOAD_AT) unloadVideo(getVideo(c));
      }
    }

    const io = new IntersectionObserver(
      (entries) => {
        for (const e of entries) ratios.set(e.target, e.intersectionRatio);

        if (rafId) return;
        rafId = requestAnimationFrame(() => {
          rafId = 0;
          applyActive(pickBestActive());
        });
      },
      {
        root: null,
        rootMargin: "-15% 0px -15% 0px",
        threshold: [0, 0.1, 0.25, 0.4, 0.55, 0.75, 1],
      }
    );

    cards.forEach((c) => io.observe(c));
  })();
</script>
