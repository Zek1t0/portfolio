---
const {
  title = "Project title",
  subtitle = "Short subtitle",
  description1 = "",
  description2 = "",
  tags,                 // <- sin default
  meta = [],            // <- nuevo
  imageSrc = "/PFP.jpg",
  imageAlt = "Project preview",
  videoSrc = "",
  liveUrl = "",
  repoUrl = "",
} = Astro.props;

const FALLBACK_TAGS = ["Astro", "HTML", "CSS", "JavaScript"];

const splitTokens = (s) =>
  String(s ?? "")
    .split("·")
    .map((x) => x.trim())
    .filter(Boolean);

// saca tags desde meta[].value (Technology/Language/Framework/Tool)
const tagsFromMetaRaw = meta.flatMap((m) => splitTokens(m.value));

// unique manteniendo orden
const seen = new Set();
const tagsFromMeta = tagsFromMetaRaw.filter((t) => (seen.has(t) ? false : (seen.add(t), true)));

const tagsToRender =
  Array.isArray(tags) && tags.length
    ? tags
    : tagsFromMeta.length
      ? tagsFromMeta
      : FALLBACK_TAGS;

const hasVideo = Boolean(videoSrc && videoSrc.trim().length);

const ICONS = {
  Astro: `<svg width="85" height="107" viewBox="0 0 85 107" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M27.59 91.137c-4.834-4.42-6.246-13.704-4.232-20.43 3.492 4.241 8.33 5.584 13.342 6.343 7.737 1.17 15.336.732 22.523-2.804.822-.405 1.582-.943 2.48-1.489.675 1.957.85 3.932.615 5.943-.573 4.896-3.01 8.678-6.885 11.545-1.55 1.147-3.19 2.172-4.79 3.253-4.917 3.323-6.247 7.22-4.4 12.888.044.139.084.277.183.614-2.51-1.124-4.344-2.76-5.742-4.911-1.475-2.27-2.177-4.78-2.214-7.498-.019-1.322-.019-2.656-.197-3.96-.434-3.178-1.926-4.601-4.737-4.683-2.884-.084-5.166 1.699-5.771 4.507-.046.216-.113.429-.18.68zM0 69.587s14.314-6.973 28.668-6.973L39.49 29.12c.405-1.62 1.588-2.72 2.924-2.72s2.518 1.1 2.924 2.72L56.16 62.614c17 0 28.668 6.973 28.668 6.973S60.514 3.352 60.467 3.219C59.769 1.261 58.591 0 57.003 0H27.827c-1.588 0-2.718 1.261-3.464 3.22C24.311 3.35 0 69.586 0 69.586"/></svg>`,
  TailwindCSS: `<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M7 9c1.5-2.6 3.7-3.9 6.5-3.9 4.2 0 5.3 3.1 7.5 3.9-1.5 2.6-3.7 3.9-6.5 3.9C10.3 12.8 9.2 9.7 7 9zm-4 6c1.5-2.6 3.7-3.9 6.5-3.9 4.2 0 5.3 3.1 7.5 3.9-1.5 2.6-3.7 3.9-6.5 3.9C6.3 18.8 5.2 15.7 3 15z"/></svg>`,
  HTML: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><title>HTML5 Logo Badge</title><path fill="#e34f26" d="M71 460 30 0h451l-41 460-185 52"/><path fill="#ef652a" d="m256 472 149-41 35-394H256"/><path fill="#ebebeb" d="M256 208h-75l-5-58h80V94H114l1 15 14 156h127zm0 147h-1l-63-17-4-45h-56l7 89 116 32h1z"/><path fill="#fff" d="M255 208v57h70l-7 73-63 17v59l116-32 1-10 13-149 2-15h-16zm0-114v56h137l1-12 3-29 1-15z"/></svg>`,
  CSS: `<svg xmlns="http://www.w3.org/2000/svg" width="1000" height="1000" viewBox="0 0 1000 1000" aria-labelledby="css-logo-title css-logo-description"><title>CSS Logo</title><desc>A purple square with rounded corners and the letters CSS inside in white</desc><path fill="#639" d="M0 0h840a160 160 0 0 1 160 160v680a160 160 0 0 1-160 160H160A160 160 0 0 1 0 840z"/><path fill="#fff" d="M358.1 920c-64.23-.06-103.86-36.23-103.1-102.79V648.82c0-33.74 9.88-59.4 29.64-76.96 35.49-34.19 117.83-36.27 152.59.52 21.42 18.89 29.5 57.48 27.58 93.49h-73.72c.56-14.15-.19-35.58-8.51-43.65-10.81-14.63-39.36-12.91-46.91 2.32-4.64 8.26-6.96 20.49-6.96 36.67v146.18c0 30.65 10.65 46.15 31.96 46.49 9.96 0 17.53-3.62 22.68-10.85 7.19-8.58 8.31-27.58 7.73-41.32h73.72c5.04 70.07-36.32 119.16-106.71 118.29Zm234.04 0c-71.17.98-103.01-49.66-101.04-118.29h69.59c-1.93 29.92 8.35 57.17 32.99 55.27 10.99 0 18.73-3.44 23.2-10.33 8.5-12.59 10.09-48.95-2.06-63.02-8.49-13.55-39.03-25.51-55.16-33.57-23.03-11.02-39.61-24.1-49.75-39.26-22.87-33.64-20.75-107.48 11.34-137.4 31.18-36.92 112.61-38.62 143.82-.77 19.25 19.51 27.66 57.9 26.03 93.23h-67.02c.57-14.52-.8-37.95-6.44-46.49-3.95-7.23-11.43-10.85-22.42-10.85-19.59 0-29.38 11.71-29.38 35.12.21 24.86 9.9 35.06 32.48 45.45 29.24 11.36 66.42 30.76 79.9 54.24 40.2 71.54 12.62 180.82-86.09 176.65Zm224.76 0c-71.17.98-103.01-49.66-101.04-118.29h69.59c-1.93 29.92 8.35 57.17 32.99 55.27 10.99 0 18.73-3.44 23.2-10.33 8.5-12.59 10.09-48.95-2.06-63.02-8.49-13.55-39.03-25.51-55.16-33.57-23.03-11.02-39.61-24.1-49.75-39.26-22.87-33.64-20.75-107.48 11.34-137.4 31.18-36.92 112.61-38.62 143.82-.77 19.25 19.51 27.66 57.9 26.03 93.23h-67.02c.57-14.52-.8-37.95-6.44-46.49-3.95-7.23-11.43-10.85-22.42-10.85-19.59 0-29.38 11.71-29.38 35.12.21 24.86 9.9 35.06 32.48 45.45 29.24 11.36 66.42 30.76 79.9 54.24 40.2 71.54 12.62 180.82-86.09 176.65Z"/></svg>`,
  JavaScript: `<img src="/mark/JS.svg" alt="" aria-hidden="true" />`,
  TypeScript: `<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M3 3h18v18H3V3zm4 5h6v2H11v8H9V10H7V8zm11 3c-.4-.7-1-.9-1.7-.9-.8 0-1.3.4-1.3 1 0 .7.5 1 1.8 1.4 1.8.6 2.8 1.4 2.8 3.1 0 1.8-1.4 3-3.6 3-1.8 0-3-.7-3.7-2l1.7-1c.5.9 1.1 1.2 2.1 1.2.9 0 1.5-.4 1.5-1.1 0-.8-.6-1.1-2-1.6-1.7-.6-2.7-1.3-2.7-3 0-1.6 1.2-2.8 3.2-2.8 1.4 0 2.4.5 3.1 1.7L18 11z"/></svg>`,
  Django: `<img src="/mark/DJango.svg" alt="" aria-hidden="true" />`,
  Python: `<img src="/mark/Py.svg" alt="" aria-hidden="true" />`,
  SQL: `<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2c4.4 0 8 1.8 8 4v12c0 2.2-3.6 4-8 4s-8-1.8-8-4V6c0-2.2 3.6-4 8-4z"/></svg>`,
  Git: `<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M13.6 3.6l6.8 6.8a2 2 0 010 2.8l-6.8 6.8a2 2 0 01-2.8 0l-6.8-6.8a2 2 0 010-2.8l6.8-6.8a2 2 0 012.8 0z"/></svg>`,
  GitHub: `<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2a10 10 0 00-3.2 19.5c.5.1.7-.2.7-.5v-1.8c-3 .6-3.6-1.3-3.6-1.3-.5-1.1-1.2-1.4-1.2-1.4-1-.7.1-.7.1-.7 1.1.1 1.7 1.2 1.7 1.2 1 .1.7 1.2 2.4 1.4.1-.7.4-1.2.7-1.5-2.4-.3-4.9-1.2-4.9-5.3 0-1.2.4-2.1 1.1-2.9-.1-.3-.5-1.4.1-2.9 0 0 .9-.3 3 .9a10 10 0 015.4 0c2.1-1.2 3-.9 3-.9.6 1.5.2 2.6.1 2.9.7.8 1.1 1.7 1.1 2.9 0 4.1-2.5 5-4.9 5.3.4.3.8 1 .8 2v3c0 .3.2.6.7.5A10 10 0 0012 2z"/></svg>`,
  Teamwork: `<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 12a5 5 0 100-10 5 5 0 000 10zm0 2c-3.3 0-10 1.7-10 5v3h20v-3c0-3.3-6.7-5-10-5z"/></svg>`,
  default: `<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 6a6 6 0 100 12 6 6 0 000-12z"/></svg>`,
};

const iconFor = (tag) => ICONS[tag] ?? ICONS.default;
---

<!-- Fijamos alto SOLO en desktop -->
<div
  class="bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 border border-amber-200 dark:border-gray-700 rounded-3xl overflow-hidden shadow-lg lg:h-[420px]"
  data-project-card
  data-inview="false"
  data-has-video={hasVideo ? "true" : "false"}
>
  <div class="flex flex-col lg:flex-row h-full">
    <!-- IZQUIERDA: flex-col + texto scrollea si se pasa -->
    <div class="flex-1 p-8 lg:p-10 h-full flex flex-col">
      <!-- header -->
      <div class="mb-4">
        <div class="flex justify-between items-start gap-4">
          <h3 class="text-3xl lg:text-4xl font-bold text-cerise-600 dark:text-emerald-400 leading-tight">
            {title}
          </h3>

          <div class="flex items-center gap-2 shrink-0 opacity-85">
            {repoUrl && (
              <a
                href={repoUrl}
                target="_blank"
                rel="noreferrer"
                class="rounded-lg p-2 hover:bg-black/5 dark:hover:bg-white/10 transition"
                aria-label="Repository"
                title="Repository"
              >
                <span class="icon-btn" set:html={ICONS.GitHub} />
              </a>
            )}

            {liveUrl && (
              <a
                href={liveUrl}
                target="_blank"
                rel="noreferrer"
                class="rounded-lg p-2 hover:bg-black/5 dark:hover:bg-white/10 transition"
                aria-label="Live"
                title="Live"
              >
                <svg class="icon-btn" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M14 3h7v7h-2V6.4l-9.3 9.3-1.4-1.4 9.3-9.3H14V3zM5 5h6v2H7v10h10v-4h2v6H5V5z"/>
                </svg>
              </a>
            )}
          </div>
        </div>
      </div>

      <!-- este bloque es el que crece/encoge; si hay mucho texto, scrollea -->
      <div class="flex-1 overflow-auto pr-2 scrollbox">
        <h4 class="text-amber-700 dark:text-white text-lg lg:text-xl font-bold mb-4">
          {subtitle}
        </h4>

        {description1 && <p class="mb-4">{description1}</p>}
        {description2 && <p class="mb-2">{description2}</p>}
      </div>

      <!-- TAGS abajo, siempre visibles -->
      <div class="mt-6 flex flex-wrap gap-2">
        {tagsToRender.map((t) => (
          <span class="tag-pill">
            <span class="tag-ico" set:html={iconFor(t)} />
            <span class="tag-txt">{t}</span>
          </span>
        ))}
      </div>
    </div>

    <!-- DERECHA: ocupa todo el alto y centra el frame -->
    <div class="lg:w-1/2 relative overflow-hidden h-[22rem] sm:h-[26rem] lg:h-full">
      <div class="card-bg card-bg--static"></div>
      <div class="card-bg card-bg--active"></div>

      <div class="relative z-10 w-full h-full p-6 lg:p-8 flex items-center justify-center">
        <div class="media-frame">
          <img
            src={imageSrc}
            alt={imageAlt}
            class="project-img"
            loading="lazy"
            decoding="async"
            width="1280"
            height="720"
          />

          {hasVideo && (
            <video
              class="project-video"
              muted
              loop
              playsinline
              preload="none"
              poster={imageSrc}
              data-video-src={videoSrc}
              data-loaded="false"
            />
          )}
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  [data-project-card]{
    content-visibility: auto;
    contain-intrinsic-size: 980px 560px;
    contain: layout paint style;
  }

  /* icon buttons */
  .icon-btn{
    width: 20px;
    height: 20px;
    fill: currentColor;
    display: block;
    opacity: .9;
  }

  /* pills */
  .tag-pill{
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 6px 12px;
    border-radius: 999px;
    border: 1px solid rgba(0,0,0,.10);
    background: rgba(255,255,255,.70);
    box-shadow: 0 1px 0 rgba(0,0,0,.02);
    font-size: 12px;
    line-height: 1;
    user-select: none;
  }
  :global(.dark) .tag-pill{
    border-color: rgba(255,255,255,.10);
    background: rgba(255,255,255,.06);
    box-shadow: none;
  }
  .tag-ico{
    width: 14px;
    height: 14px;
    display: inline-grid;
    place-items: center;
    opacity: .9;
  }
  .tag-ico :global(svg){
    width: 14px;
    height: 14px;
    fill: currentColor;
    display: block;
  }
  .tag-txt{ font-weight: 600; opacity: .92; }

  /* backgrounds */
  [data-project-card] .card-bg {
    position: absolute;
    inset: 0;
    transition: opacity 300ms ease, transform 300ms ease;
  }
  [data-project-card] .card-bg--static {
    opacity: 1;
    background:
      radial-gradient(1200px 500px at 20% 20%, rgba(245, 158, 11, 0.22), transparent 60%),
      radial-gradient(900px 600px at 80% 70%, rgba(236, 72, 153, 0.14), transparent 58%),
      linear-gradient(135deg, rgba(251, 191, 36, 0.18), rgba(245, 158, 11, 0.10));
    transform: scale(1);
  }
  [data-project-card] .card-bg--active {
    opacity: 0;
    background:
      radial-gradient(900px 600px at 25% 35%, rgba(16, 185, 129, 0.18), transparent 62%),
      radial-gradient(900px 600px at 75% 70%, rgba(236, 72, 153, 0.16), transparent 64%),
      linear-gradient(135deg, rgba(15, 23, 42, 0.22), rgba(17, 24, 39, 0.10));
    transform: scale(1.02);
  }

  /* media */
  .media-frame {
    width: 100%;
    aspect-ratio: 16 / 9;
    border-radius: 26px;
    overflow: hidden;
    box-shadow: 0 16px 44px rgba(0,0,0,0.20);
    position: relative;
    background: rgba(0,0,0,0.06);
  }

  .project-img,
  .project-video {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    transition: opacity 220ms ease;
    object-position: center;
  }

  .project-img { object-fit: cover; opacity: 1; }

  .project-video {
    object-fit: contain;
    background: rgba(0,0,0,0.10);
    opacity: 0;
  }

  [data-project-card][data-inview="true"] .card-bg--static { opacity: 0; transform: scale(0.995); }
  [data-project-card][data-inview="true"] .card-bg--active { opacity: 1; }

  [data-project-card][data-has-video="true"][data-inview="true"] .project-img { opacity: 0; }
  [data-project-card][data-has-video="true"][data-inview="true"] .project-video { opacity: 1; }
  /* Scrollbar prolija (solo para el bloque de texto) */
.scrollbox{
  scrollbar-width: thin; /* Firefox */
  scrollbar-color: rgba(0,0,0,.22) transparent;
}

:global(.dark) .scrollbox{
  scrollbar-color: rgba(255,255,255,.22) transparent;
}

/* Chrome/Edge/Safari */
.scrollbox::-webkit-scrollbar{
  width: 10px;
}

.scrollbox::-webkit-scrollbar-track{
  background: transparent;
  border-radius: 999px;
}

.scrollbox::-webkit-scrollbar-thumb{
  background: rgba(0,0,0,.18);
  border-radius: 999px;
  border: 3px solid transparent;      /* hace el thumb más “fino” */
  background-clip: padding-box;        /* para que el borde sea aire */
}

.scrollbox::-webkit-scrollbar-thumb:hover{
  background: rgba(0,0,0,.28);
  border: 3px solid transparent;
  background-clip: padding-box;
}

:global(.dark) .scrollbox::-webkit-scrollbar-thumb{
  background: rgba(255,255,255,.16);
  border: 3px solid transparent;
  background-clip: padding-box;
}

:global(.dark) .scrollbox::-webkit-scrollbar-thumb:hover{
  background: rgba(255,255,255,.26);
  border: 3px solid transparent;
  background-clip: padding-box;
}

  /* scroll adentro sin que quede feo */
  .flex-1.overflow-auto { scrollbar-width: thin; }

  @media (prefers-reduced-motion: reduce) {
    [data-project-card] .card-bg,
    .project-img,
    .project-video {
      transition: none !important;
      animation: none !important;
    }
  }
</style>
