---
// Icons (raw -> string)
import astroIcon from "../icons/astro.svg?raw";
import tailwindcssIcon from "../icons/tailwindcss.svg?raw";
import htmlIcon from "../icons/html.svg?raw";
import cssIcon from "../icons/css.svg?raw";
import javascriptIcon from "../icons/javascript.svg?raw";
import typescriptIcon from "../icons/typescript.svg?raw";
import djangoIcon from "../icons/django.svg?raw";
import pythonIcon from "../icons/python.svg?raw";
import sqlIcon from "../icons/sql.svg?raw";
import gitIcon from "../icons/git.svg?raw";
import githubIcon from "../icons/github.svg?raw";
import teamworkIcon from "../icons/teamwork.svg?raw";

// Si no querés crear default.svg, dejá esto comentado
// import defaultIcon from "../icons/default.svg?raw";

const {
  title = "Project title",
  subtitle = "Short subtitle",
  description1 = "",
  description2 = "",
  tags,
  meta = [],
  imageSrc = "/PFP.jpg",
  imageAlt = "Project preview",
  videoSrc = "",
  liveUrl = "",
  repoUrl = "",
} = Astro.props;

const FALLBACK_TAGS = ["Astro", "HTML", "CSS", "JavaScript"];

const splitTokens = (s) =>
  String(s ?? "")
    .split("·")
    .map((x) => x.trim())
    .filter(Boolean);

// tags desde meta[].value (Technology/Language/Framework/Tool)
const tagsFromMetaRaw = meta.flatMap((m) => splitTokens(m.value));

// unique manteniendo orden (case-insensitive)
const seen = new Set();
const tagsFromMeta = tagsFromMetaRaw.filter((t) => {
  const k = String(t).trim().toLowerCase();
  if (!k) return false;
  if (seen.has(k)) return false;
  seen.add(k);
  return true;
});

const tagsToRender =
  Array.isArray(tags) && tags.length
    ? tags
    : tagsFromMeta.length
      ? tagsFromMeta
      : FALLBACK_TAGS;

const hasVideo = Boolean(videoSrc && videoSrc.trim().length);

// Normaliza tags para matchear iconos
const normalize = (t) =>
  String(t ?? "")
    .trim()
    .toLowerCase()
    .replace(/\s+/g, "");

const ICONS = {
  astro: astroIcon,
  tailwindcss: tailwindcssIcon,
  html: htmlIcon,
  css: cssIcon,
  javascript: javascriptIcon,
  typescript: typescriptIcon,
  django: djangoIcon,
  python: pythonIcon,
  sql: sqlIcon,
  git: gitIcon,
  github: githubIcon,
  teamwork: teamworkIcon,

  // aliases
  tailwind: tailwindcssIcon,
  js: javascriptIcon,
  ts: typescriptIcon,

  // default: defaultIcon,
  default: `<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 6a6 6 0 100 12 6 6 0 000-12z"/></svg>`,
};

const iconFor = (tag) => {
  const key = normalize(tag);
  return ICONS[key] ?? ICONS.default;
};
---

<!-- Fijamos alto SOLO en desktop -->
<div
  class="bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 border border-amber-200 dark:border-gray-700 rounded-3xl overflow-hidden shadow-lg lg:h-[420px]"
  data-project-card
  data-inview="false"
  data-has-video={hasVideo ? "true" : "false"}
>
  <div class="flex flex-col lg:flex-row h-full relative">
    <!-- fondos -->
    <div class="card-bg card-bg--static"></div>
    <div class="card-bg card-bg--active"></div>

    <!-- IZQUIERDA -->
    <div class="flex-1 p-8 lg:p-10 h-full flex flex-col relative">
      <!-- header -->
      <div class="mb-4">
        <div class="flex justify-between items-start gap-4">
          <h3 class="text-3xl lg:text-4xl font-bold text-cerise-600 dark:text-emerald-400 leading-tight">
            {title}
          </h3>

          <div class="flex items-center gap-2 shrink-0 opacity-90">
            {repoUrl && (
              <a
                href={repoUrl}
                target="_blank"
                rel="noreferrer"
                class="rounded-lg p-2 hover:bg-black/5 dark:hover:bg-white/10 transition"
                aria-label="Repository"
                title="Repository"
              >
                <span class="icon-btn" set:html={githubIcon} aria-hidden="true" />
              </a>
            )}

            {liveUrl && (
              <a
                href={liveUrl}
                target="_blank"
                rel="noreferrer"
                class="rounded-lg p-2 hover:bg-black/5 dark:hover:bg-white/10 transition"
                aria-label="Live"
                title="Live"
              >
                <svg class="icon-btn" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true" >
                  <path d="M14 3h7v7h-2V6.4l-9.3 9.3-1.4-1.4 9.3-9.3H14V3zM5 5h6v2H7v10h10v-4h2v6H5V5z"/>
                </svg>
              </a>
            )}
          </div>
        </div>
      </div>

      <!-- bloque scrolleable -->
      <div class="flex-1 overflow-auto pr-2 scrollbox">
        <h4 class="text-amber-700 dark:text-white text-lg lg:text-xl font-bold mb-4">
          {subtitle}
        </h4>

        {description1 && (
          <p class="text-base lg:text-lg text-gray-700 dark:text-gray-300 leading-relaxed mb-4">
            {description1}
          </p>
        )}

        {description2 && (
          <p class="text-base lg:text-lg text-gray-700 dark:text-gray-300 leading-relaxed">
            {description2}
          </p>
        )}
      </div>

      <!-- tags -->
      <div class="mt-6 flex flex-wrap gap-2">
        {tagsToRender.map((t) => (
          <span class="tag-pill">
            <span class="tag-ico" set:html={iconFor(t)} />
            <span class="tag-txt">{t}</span>
          </span>
        ))}
      </div>
    </div>

    <!-- DERECHA -->
    <div class="flex-1 p-8 lg:p-10 flex items-center justify-center relative">
      <div class="media-frame">
        {hasVideo ? (
          <>
            <img class="project-img" src={imageSrc} alt={imageAlt} loading="lazy" />
            <video
            class="project-video"
            muted
            loop
            playsinline
            preload="none"
            poster={imageSrc}
            data-video-src={videoSrc}
            ></video>
          </>
        ) : (
          <img class="project-img" src={imageSrc} alt={imageAlt} loading="lazy" />
        )}
      </div>
    </div>
  </div>
</div>

<style>
  [data-project-card]{
    contain-intrinsic-size: 980px 560px;
    contain: layout paint style;
  }

  /* icon buttons */
  .icon-btn{
    width: 20px;
    height: 20px;
    display: block;
    opacity: .9;
  }

  /* si el icono ES un svg con class="icon-btn" */
  :global(svg.icon-btn),
  :global(svg.icon-btn *) {
    width: 20px;
    height: 20px;
    fill: currentColor;
    stroke: currentColor;
  }

  /* si el icono viene inline dentro de un span.icon-btn */
  .icon-btn :global(svg),
  .icon-btn :global(svg *) {
    width: 20px;
    height: 20px;
    display: block;
    fill: currentColor;
    stroke: currentColor;
  }


  /* pills */
  .tag-pill{
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 6px 12px;
    border-radius: 999px;
    border: 1px solid rgba(0,0,0,.10);
    background: rgba(255,255,255,.70);
    box-shadow: 0 1px 0 rgba(0,0,0,.02);
    font-size: 12px;
    line-height: 1;
    user-select: none;
  }
  :global(.dark) .tag-pill{
    border-color: rgba(255,255,255,.10);
    background: rgba(255,255,255,.06);
    box-shadow: none;
  }

  .tag-ico{
    width: 14px;
    height: 14px;
    display: inline-grid;
    place-items: center;
    opacity: .9;
  }

  /* CLAVE: como ahora el SVG está inline (raw + set:html), lo teñimos con currentColor */
  .tag-ico :global(svg){
    width: 14px;
    height: 14px;
    display: block;
    fill: currentColor;
    stroke: currentColor;
  }

  .tag-txt{ font-weight: 600; opacity: .92; }

  /* backgrounds */
  [data-project-card] .card-bg {
    position: absolute;
    inset: 0;
    transition: opacity 300ms ease, transform 300ms ease;
  }
  [data-project-card] .card-bg--static {
    opacity: 1;
    background:
      radial-gradient(1200px 500px at 20% 20%, rgba(245, 158, 11, 0.22), transparent 60%),
      radial-gradient(900px 600px at 80% 70%, rgba(236, 72, 153, 0.14), transparent 58%),
      linear-gradient(135deg, rgba(251, 191, 36, 0.18), rgba(245, 158, 11, 0.10));
    transform: scale(1);
  }
  [data-project-card] .card-bg--active {
    opacity: 0;
    background:
      radial-gradient(900px 600px at 25% 35%, rgba(16, 185, 129, 0.18), transparent 62%),
      radial-gradient(900px 600px at 75% 70%, rgba(236, 72, 153, 0.16), transparent 64%),
      linear-gradient(135deg, rgba(15, 23, 42, 0.22), rgba(17, 24, 39, 0.10));
    transform: scale(1.02);
  }

  /* media */
  .media-frame {
    width: 100%;
    aspect-ratio: 16 / 9;
    border-radius: 26px;
    overflow: hidden;
    box-shadow: 0 16px 44px rgba(0,0,0,0.20);
    position: relative;
    background: rgba(0,0,0,0.06);
  }

  .project-img,
  .project-video {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    transition: opacity 220ms ease;
    object-position: center;
  }

  .project-img { object-fit: cover; opacity: 1; }

  .project-video {
    object-fit: contain;
    background: rgba(0,0,0,0.10);
    opacity: 0;
  }

  [data-project-card][data-inview="true"] .card-bg--static { opacity: 0; transform: scale(0.995); }
  [data-project-card][data-inview="true"] .card-bg--active { opacity: 1; }

  [data-project-card][data-has-video="true"][data-inview="true"] .project-img { opacity: 0; }
  [data-project-card][data-has-video="true"][data-inview="true"] .project-video { opacity: 1; }

  /* Scrollbar prolija */
  .scrollbox{
    scrollbar-width: thin; /* Firefox */
    scrollbar-color: rgba(0,0,0,.22) transparent;
  }
  :global(.dark) .scrollbox{
    scrollbar-color: rgba(255,255,255,.22) transparent;
  }
  .scrollbox::-webkit-scrollbar{ width: 10px; }
  .scrollbox::-webkit-scrollbar-track{ background: transparent; border-radius: 999px; }
  .scrollbox::-webkit-scrollbar-thumb{
    background: rgba(0,0,0,.18);
    border-radius: 999px;
    border: 3px solid transparent;
    background-clip: padding-box;
  }
  .scrollbox::-webkit-scrollbar-thumb:hover{
    background: rgba(0,0,0,.28);
    border: 3px solid transparent;
    background-clip: padding-box;
  }
  :global(.dark) .scrollbox::-webkit-scrollbar-thumb{
    background: rgba(255,255,255,.16);
    border: 3px solid transparent;
    background-clip: padding-box;
  }
  :global(.dark) .scrollbox::-webkit-scrollbar-thumb:hover{
    background: rgba(255,255,255,.26);
    border: 3px solid transparent;
    background-clip: padding-box;
  }

  @media (prefers-reduced-motion: reduce) {
    [data-project-card] .card-bg,
    .project-img,
    .project-video {
      transition: none !important;
      animation: none !important;
    }
  }
</style>